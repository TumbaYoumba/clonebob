.for_cleanup:
  stage: cleanup
  extends:
    - .needs_init_and_scanners
    - .allow_failure
    - .tags

.needs_init_and_scanners:
  needs: 
    - job: init
      artifacts: true
    - job: scan:trufflehog3
    - job: scan:gitleaks


auto-falser:
  image: "$CI_REGISTRY/$SEC_PATH_TO_IMAGES/toolset:latest"
  script:
    - python3 /falser/falser.py
  extends: 
    - .for_cleanup


patch-libraries:pip:
  image: "$CI_REGISTRY/$SEC_PATH_TO_IMAGES/ws-patcher:latest"
  script:
    - python3 -m pip_audit -r requirements.txt --fix  
  extends: 
    - .for_cleanup
  rules:
    - if: '$SEC_IMAGE_SCAN_ENABLE == "true"'
      exists:
        - 'requirements.txt'
      
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - requirements.txt
    when: always


patch-libraries:npm:
  image: "$CI_REGISTRY/$SEC_PATH_TO_IMAGES/ws-patcher:latest"
  script:
    - npm install
    - npm audit fix --force
  extends: 
    - .for_cleanup
  rules:
    - if: '$SEC_IMAGE_SCAN_ENABLE == "true"'
      exists:
        - 'package.json'
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - package.json
    when: always


patch-libraries:go:
  image: "$CI_REGISTRY/$SEC_PATH_TO_IMAGES/ws-patcher:latest"
  script:
    - go get -u && go mod tidy
  extends: 
    - .for_cleanup
  rules:
    - if: '$SEC_IMAGE_SCAN_ENABLE == "true"'
      exists:
        - 'go.mod'
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - go.mod
    when: always

